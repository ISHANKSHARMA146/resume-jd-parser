<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>JD & ATS Resume Generator</title>
    <!-- Include jsPDF, html2canvas, and html-docx-js from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html-docx-js/0.4.1/html-docx.js"></script>
    <style>
      /* General Reset and Base Styles */
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
        background-color: #f2f4f8;
        color: #1f2937;
      }
      *, *::before, *::after {
        box-sizing: border-box;
      }
      
      /* Layout: Sidebar, Main Area, Results */
      .container-fluid {
        display: flex;
        width: 100%;
        height: 100%;
      }
      .sidebar {
        width: 260px;
        background: #0f766e;
        color: #ffffff;
        padding: 24px;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
      }
      .logo {
        font-size: 1.3rem;
        font-weight: 700;
        margin-bottom: 1.5rem;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      .nav-btn {
        width: 100%;
        background: transparent;
        border: none;
        padding: 12px 16px;
        margin-bottom: 6px;
        font-size: 0.95rem;
        font-weight: 600;
        text-align: left;
        color: #ffffff;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.2s;
      }
      .nav-btn:hover,
      .nav-btn.active {
        background: #0d5e57;
      }
      
      .main-center {
        flex: 0 0 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
        background: #f2f4f8;
      }
      .upload-section {
        width: 500px;
        max-width: 90%;
        background: #ffffff;
        padding: 24px;
        border-radius: 8px;
        box-shadow: 0 3px 12px rgba(0, 0, 0, 0.06);
        text-align: center;
      }
      .upload-section h3 {
        margin-bottom: 1rem;
        font-size: 1.2rem;
        font-weight: 700;
        color: #1f2937;
      }
      .drop-zone {
        border: 2px dashed #cbd5e1;
        padding: 16px;
        border-radius: 6px;
        margin: 1rem 0;
        cursor: pointer;
        background-color: #f8fafc;
        transition: background 0.2s;
      }
      .drop-zone:hover {
        background-color: #e2e8f0;
      }
      .drop-zone p {
        margin: 0;
        font-size: 0.9rem;
        color: #6b7280;
      }
      .input-box {
        width: 100%;
        padding: 8px 10px;
        margin-top: 8px;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        font-size: 0.9rem;
      }
      .submit-btn {
        margin-top: 12px;
        padding: 10px 20px;
        background: #3b82f6;
        color: #ffffff;
        border: none;
        border-radius: 6px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
      }
      .submit-btn:hover {
        background: #2563eb;
      }
      .error {
        margin-top: 8px;
        color: #ef4444;
        font-size: 0.9rem;
      }
      
      /* Results Panel and Resume Preview */
      .results {
        flex: 1;
        background: #ffffff;
        border-left: 1px solid #e5e7eb;
        padding: 16px;
        display: flex;
        flex-direction: column;
      }
      .results h3 {
        font-size: 1.15rem;
        margin-bottom: 0.5rem;
        font-weight: 700;
        color: #1f2937;
      }
      .scrollable-results {
        flex: 1;
        overflow-y: auto;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 12px;
        background: #f9fafb;
      }
      
      /* ATS Resume Preview Styles */
      .ats-resume-preview {
        max-width: 800px;
        margin: 20px auto;
        padding: 20px;
        background: #ffffff;
        border: 1px solid #e5e7eb;
      }
      .ats-resume-preview h1.candidate-name {
        text-align: center;
        font-size: 2rem;
        margin-bottom: 10px;
      }
      .ats-resume-preview .date {
        text-align: right;
        font-size: 0.9rem;
        color: #555;
      }
      .ats-resume-preview h2,
      .ats-resume-preview h3 {
        text-align: left;
        margin-top: 20px;
      }
      .ats-resume-preview p,
      .ats-resume-preview li {
        text-align: left;
        font-size: 0.95rem;
        line-height: 1.5;
      }
      .download-buttons {
        margin-top: 12px;
        text-align: center;
      }
      .download-buttons button {
        padding: 8px 16px;
        margin: 0 4px;
        background: #3b82f6;
        border: none;
        border-radius: 4px;
        color: #fff;
        cursor: pointer;
      }
      .download-buttons button:hover {
        background: #2563eb;
      }
      
      /* Candidate List for Other API Responses */
      .candidate-list {
        list-style: none;
        padding: 0;
      }
      .candidate-item {
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        margin-bottom: 10px;
        background: #fff;
      }
      .candidate-header {
        background: #3b82f6;
        color: #fff;
        padding: 10px;
        cursor: pointer;
        font-weight: 600;
        border: none;
        width: 100%;
        text-align: left;
      }
      .candidate-content {
        display: none;
        padding: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <!-- Sidebar -->
      <nav class="sidebar" id="sidebar"></nav>
      <!-- Main Center: File Upload / Form Input -->
      <div class="main-center" id="main-center"></div>
      <!-- Results & Resume Preview -->
      <div class="results">
        <h3>Results</h3>
        <div id="download-csv-container" style="margin-bottom:10px; display: none;">
          <button class="submit-btn" id="download-csv-btn">Download CSV</button>
        </div>
        <div id="resume-preview" class="ats-resume-preview" style="display: none;"></div>
        <div class="scrollable-results" id="results-container"></div>
      </div>
    </div>
    <script>
      // Global state variables
      let selectedApi = null;
      let uploadedFiles = null;
      let parsedData = null;
      let resumeContent = "";
      let loading = false;
      let error = null;
      let additionalInput = "";
      const expandedSections = {};
      
      // Base URL for API calls
      const baseURL = "http://localhost:8000";
      
      // API options (including resume generation endpoints)
      const apiOptions = [
        { id: "parse-resume", label: "Parse Resume" },
        { id: "parse-job-description", label: "Parse Job Description" },
        { id: "job-description-enhance", label: "Enhance JD" },
        { id: "score-resumes", label: "Score Resumes" },
        { id: "generate-resume-from-upload", label: "Generate Resume from Upload" },
        { id: "generate-resume-from-form", label: "Generate Resume from Form" }
      ];
      
      // Label mappings for rendering JSON data
      const labelMappings = {
        candidate_name: "Name",
        email_address: "Email",
        phone_number: "Phone",
        work_experience: "Work Experience",
        educations_duration: "Education Duration",
        experiences: "Experience",
        educations: "Education",
        social_urls: "Social Links",
        skills: "Skills",
        job_title: "Job Title",
        job_description: "Job Description",
        required_skills: "Required Skills",
        min_work_experience: "Minimum Experience",
        enhanced_job_description: "Enhanced Job Description",
        generated_candidates: "Generated Candidates",
        resume_score: "Resume Score",
        gap_analysis: "Gap Analysis",
        candidate_summary: "Candidate Summary",
        closest_sample_candidate: "Closest Candidate",
        recommendations: "Recommendations"
      };
      
      // Render Sidebar
      function renderSidebar() {
        const sidebar = document.getElementById("sidebar");
        sidebar.innerHTML = `<h2 class="logo">JD & ATS Resume</h2>`;
        apiOptions.forEach(option => {
          const btn = document.createElement("button");
          btn.className = "nav-btn" + (selectedApi === option.id ? " active" : "");
          btn.textContent = option.label;
          btn.addEventListener("click", () => handleApiSelection(option.id));
          sidebar.appendChild(btn);
        });
      }
      
      // Handle API Selection
      function handleApiSelection(apiId) {
        selectedApi = apiId;
        uploadedFiles = null;
        parsedData = null;
        resumeContent = "";
        error = null;
        additionalInput = "";
        renderMainCenter();
        renderResultsPanel();
        renderSidebar();
      }
      
      // Render Main Center based on selected API
      function renderMainCenter() {
        const mainCenter = document.getElementById("main-center");
        mainCenter.innerHTML = "";
        if (!selectedApi) {
          mainCenter.innerHTML = `<h2 class="placeholder-text">Select an API option from the left</h2>`;
          return;
        }
        const container = document.createElement("div");
        container.className = "upload-section";
        let headerText = "";
        let additionalFieldHTML = "";
        let fileInputAttributes = "";
        switch (selectedApi) {
          case "parse-resume":
            headerText = "Parse Resume";
            fileInputAttributes = "";
            break;
          case "parse-job-description":
            headerText = "Parse Job Description";
            fileInputAttributes = "";
            break;
          case "job-description-enhance":
            headerText = "Enhance JD";
            fileInputAttributes = "";
            break;
          case "score-resumes":
            headerText = "Score Resumes";
            fileInputAttributes = "multiple";
            additionalFieldHTML = `<textarea id="additional-input" placeholder="Additional requirements (e.g. 'DevOps experience')" rows="4" class="input-box"></textarea>`;
            break;
          case "generate-resume-from-upload":
            headerText = "Generate Resume from Upload";
            fileInputAttributes = "";
            additionalFieldHTML = `<input type="text" id="output-format" placeholder="Output format (html, pdf, docx)" class="input-box" value="html" />`;
            break;
          case "generate-resume-from-form":
            headerText = "Generate Resume from Form";
            additionalFieldHTML = `<textarea id="candidate-data" placeholder='Enter candidate data in JSON format' rows="8" class="input-box"></textarea>
                                    <input type="text" id="output-format" placeholder="Output format (html, pdf, docx)" class="input-box" value="html" />`;
            break;
          default:
            headerText = "";
        }
        container.innerHTML = `<h3>${headerText}</h3>
          <div class="drop-zone">
            <input type="file" id="file-input" ${fileInputAttributes} />
            <p>Drag & drop files here or click to upload</p>
          </div>
          ${additionalFieldHTML}
          <button class="submit-btn" id="submit-btn">${loading ? "Processing..." : "Submit"}</button>
          <p class="error" id="error-message">${error ? error : ""}</p>`;
        mainCenter.appendChild(container);
      
        if (
          selectedApi === "parse-resume" ||
          selectedApi === "parse-job-description" ||
          selectedApi === "job-description-enhance" ||
          selectedApi === "score-resumes" ||
          selectedApi === "generate-resume-from-upload"
        ) {
          document.getElementById("file-input").addEventListener("change", (e) => {
            uploadedFiles = e.target.files;
          });
        }
        if (selectedApi === "score-resumes") {
          document.getElementById("additional-input").addEventListener("input", (e) => {
            additionalInput = e.target.value;
          });
        }
        if (selectedApi === "generate-resume-from-form") {
          document.getElementById("candidate-data").addEventListener("input", (e) => {
            additionalInput = e.target.value;
          });
        }
        document.getElementById("submit-btn").addEventListener("click", handleSubmit);
      }
      
      // Submit Handler: Sends FormData or JSON to API and displays the resume HTML
      async function handleSubmit() {
        if (selectedApi === "generate-resume-from-form") {
          if (!additionalInput) {
            error = "Please enter candidate data in JSON format.";
            renderMainCenter();
            return;
          }
        } else {
          if (!uploadedFiles || uploadedFiles.length === 0) {
            error = "Please upload a file.";
            renderMainCenter();
            return;
          }
        }
        loading = true;
        error = null;
        renderMainCenter();
        const formData = new FormData();
        if (selectedApi === "score-resumes") {
          for (let file of uploadedFiles) {
            formData.append("files", file);
          }
          formData.append("user_input", additionalInput);
        } else if (selectedApi === "generate-resume-from-upload") {
          formData.append("file", uploadedFiles[0]);
          const outputFormat = document.getElementById("output-format").value || "html";
          formData.append("download_format", outputFormat);
        } else if (selectedApi === "generate-resume-from-form") {
          try {
            const candidateData = JSON.parse(additionalInput);
            formData.append("download_format", document.getElementById("output-format").value || "html");
            const response = await fetch(`${baseURL}/api/${selectedApi}/`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(candidateData)
            });
            if (!response.ok) throw new Error("Error processing candidate data.");
            resumeContent = await response.text();
            displayResumePreview(resumeContent);
          } catch (e) {
            console.error(e);
            error = "Invalid JSON candidate data.";
          } finally {
            loading = false;
            renderMainCenter();
          }
          return;
        } else {
          formData.append("file", uploadedFiles[0]);
        }
      
        try {
          const response = await fetch(`${baseURL}/api/${selectedApi}/`, {
            method: "POST",
            body: formData,
          });
          if (!response.ok) throw new Error("Error processing file.");
          resumeContent = await response.text();
          displayResumePreview(resumeContent);
        } catch (err) {
          console.error(err);
          error = "Error processing file.";
        } finally {
          loading = false;
          renderMainCenter();
        }
      }
      
      // Display the resume preview with download buttons
      function displayResumePreview(htmlContent) {
        const previewContainer = document.getElementById("resume-preview");
        previewContainer.style.display = "block";
        previewContainer.innerHTML = htmlContent;
        const downloadDiv = document.createElement("div");
        downloadDiv.className = "download-buttons";
        downloadDiv.innerHTML = `
          <button onclick="downloadFile('html')">Download HTML</button>
          <button onclick="downloadFile('pdf')">Download PDF</button>
          <button onclick="downloadFile('docx')">Download DOCX</button>
        `;
        previewContainer.appendChild(downloadDiv);
      }
      
      // Download file function using the current resumeContent and format request
      async function downloadFile(format) {
        let endpoint = "";
        if (selectedApi === "generate-resume-from-upload") {
          endpoint = `${baseURL}/api/generate-resume-from-upload/`;
        } else if (selectedApi === "generate-resume-from-form") {
          endpoint = `${baseURL}/api/generate-resume-from-form/`;
        }
        const formData = new FormData();
        formData.append("download_format", format);
      
        // For upload, include the file; for form, candidate data is already processed
        if (selectedApi === "generate-resume-from-upload" && uploadedFiles && uploadedFiles.length > 0) {
          formData.append("file", uploadedFiles[0]);
        }
      
        try {
          const response = await fetch(endpoint, {
            method: "POST",
            body: formData,
          });
          if (!response.ok) throw new Error("Error downloading file.");
          const blob = await response.blob();
          triggerDownload(blob, `generated_resume.${format}`);
        } catch (e) {
          console.error(e);
        }
      }
      
      // Client-side conversion for PDF and DOCX:
      // If the resumeContent is already HTML (and previewed), we can trigger download using jsPDF/html2canvas and html-docx-js.
      async function triggerDownload(blob, filename) {
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
      
      // Initial render
      renderSidebar();
      renderMainCenter();
      renderResultsPanel();
      
      // Render results panel for non-resume responses (if needed)
      function renderResultsPanel() {
        const resultsContainer = document.getElementById("results-container");
        resultsContainer.innerHTML = "";
        if (loading) {
          resultsContainer.textContent = "Loading...";
          return;
        }
        if (parsedData) {
          const dataContainer = document.createElement("div");
          dataContainer.className = "data-container";
          if (Array.isArray(parsedData)) {
            const ul = document.createElement("ul");
            ul.className = "candidate-list";
            parsedData.forEach((item, index) => {
              const li = document.createElement("li");
              li.className = "candidate-item";
              const headerBtn = document.createElement("button");
              headerBtn.className = "candidate-header";
              const candidateName = item.candidate_name ? item.candidate_name : "Candidate " + (index + 1);
              headerBtn.textContent = (index + 1) + ") " + candidateName;
              headerBtn.addEventListener("click", function() {
                const allCandidateContents = document.querySelectorAll(".candidate-content");
                allCandidateContents.forEach(content => {
                  if (content !== this.nextElementSibling) {
                    content.style.display = "none";
                  }
                });
                const candidateContent = this.nextElementSibling;
                candidateContent.style.display = candidateContent.style.display === "block" ? "none" : "block";
              });
              li.appendChild(headerBtn);
              const detailsDiv = document.createElement("div");
              detailsDiv.className = "candidate-content";
              detailsDiv.style.display = "none";
              detailsDiv.appendChild(renderJson(item, "candidate" + index + "."));
              li.appendChild(detailsDiv);
              ul.appendChild(li);
            });
            dataContainer.appendChild(ul);
          } else {
            dataContainer.appendChild(renderJson(parsedData));
          }
          resultsContainer.appendChild(dataContainer);
        }
      }
      
      // Recursive function to render JSON as collapsible sections
      function renderJson(data, parentKey = "") {
        if (data === null || data === undefined) return document.createTextNode("");
        const container = document.createElement("div");
        if (typeof data === "object" && !Array.isArray(data)) {
          Object.entries(data).forEach(([key, value]) => {
            if (key === "vectorized_jd" || key === "logo") return;
            const label = labelMappings[key] || key.replace(/_/g, " ").toUpperCase();
            const sectionKey = parentKey + key;
            const sectionDiv = document.createElement("div");
            sectionDiv.className = "section";
            if ((typeof value === "object" && value !== null) || Array.isArray(value)) {
              const btn = document.createElement("button");
              btn.className = "collapsible";
              btn.textContent = label + " " + (expandedSections[sectionKey] ? "▲" : "▼");
              btn.addEventListener("click", () => {
                expandedSections[sectionKey] = !expandedSections[sectionKey];
                renderResultsPanel();
              });
              sectionDiv.appendChild(btn);
              if (expandedSections[sectionKey]) {
                const contentDiv = document.createElement("div");
                contentDiv.className = "content";
                if (Array.isArray(value)) {
                  if (value.length > 0 && typeof value[0] === "object") {
                    value.forEach((item, index) => {
                      const nestedKey = sectionKey + "[" + index + "]";
                      const nestedBox = document.createElement("div");
                      nestedBox.className = "nested-box";
                      const nestedBtn = document.createElement("button");
                      nestedBtn.className = "collapsible";
                      nestedBtn.textContent = label + " " + (expandedSections[nestedKey] ? "▲" : "▼");
                      nestedBtn.addEventListener("click", () => {
                        expandedSections[nestedKey] = !expandedSections[nestedKey];
                        renderResultsPanel();
                      });
                      nestedBox.appendChild(nestedBtn);
                      if (expandedSections[nestedKey]) {
                        nestedBox.appendChild(renderJson(item, nestedKey + "."));
                      }
                      contentDiv.appendChild(nestedBox);
                    });
                  } else {
                    const div = document.createElement("div");
                    div.className = "subsection";
                    const h4 = document.createElement("h4");
                    h4.textContent = label;
                    const valueDiv = document.createElement("div");
                    valueDiv.className = "auto-size-box";
                    valueDiv.textContent = value.join("; ");
                    div.appendChild(h4);
                    div.appendChild(valueDiv);
                    contentDiv.appendChild(div);
                  }
                } else {
                  contentDiv.appendChild(renderJson(value, sectionKey + "."));
                }
                sectionDiv.appendChild(contentDiv);
              }
            } else {
              const subDiv = document.createElement("div");
              subDiv.className = "subsection";
              const h4 = document.createElement("h4");
              h4.textContent = label;
              const valueDiv = document.createElement("div");
              valueDiv.className = "auto-size-box";
              valueDiv.textContent = String(value);
              subDiv.appendChild(h4);
              subDiv.appendChild(valueDiv);
              sectionDiv.appendChild(subDiv);
            }
            container.appendChild(sectionDiv);
          });
        } else {
          container.textContent = data;
        }
        return container;
      }
      
      // Download CSV function for non-resume responses
      function downloadCSV() {
        if (!parsedData) return;
        const csvContent = jsonToCSV(parsedData);
        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute("download", "output.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
      
      // Convert JSON to CSV helper function
      function jsonToCSV(data) {
        let csv = "";
        if (Array.isArray(data)) {
          const flattenedData = data.map(item => flattenObject(item));
          const headers = Array.from(flattenedData.reduce((acc, curr) => acc.concat(Object.keys(curr)), []));
          csv += headers.join(",") + "\n";
          flattenedData.forEach(row => {
            const rowData = headers.map(header => {
              const cell = row[header] !== undefined ? row[header] : "";
              return `"${cell.toString().replace(/"/g, '""')}"`;
            });
            csv += rowData.join(",") + "\n";
          });
        } else {
          const flattenedData = flattenObject(data);
          const headers = Object.keys(flattenedData);
          csv += headers.join(",") + "\n";
          const rowData = headers.map(header =>
            `"${flattenedData[header].toString().replace(/"/g, '""')}"`);
          csv += rowData.join(",") + "\n";
        }
        return csv;
      }
      
      // Flatten object helper function
      function flattenObject(obj, parentKey = "", res = {}) {
        for (let key in obj) {
          if (!obj.hasOwnProperty(key)) continue;
          if (key === "vectorized_jd") continue;
          const newKey = parentKey ? parentKey + "." + key : key;
          const value = obj[key];
          if (typeof value === "object" && value !== null && !Array.isArray(value)) {
            flattenObject(value, newKey, res);
          } else if (Array.isArray(value)) {
            if (value.length > 0 && typeof value[0] === "object") {
              const formatted = value
                .map(item =>
                  Object.entries(item)
                    .map(([k, v]) => k + ": " + v)
                    .join(", ")
                )
                .join("\n");
              res[newKey] = formatted;
            } else {
              res[newKey] = value.join("; ");
            }
          } else {
            res[newKey] = value;
          }
        }
        return res;
      }
      
      // Set up download CSV button listener
      document.getElementById("download-csv-btn").addEventListener("click", downloadCSV);
      
      // Client-side conversion for PDF and DOCX
      async function downloadFile(format) {
        let endpoint = "";
        if (selectedApi === "generate-resume-from-upload") {
          endpoint = `${baseURL}/api/generate-resume-from-upload/`;
        } else if (selectedApi === "generate-resume-from-form") {
          endpoint = `${baseURL}/api/generate-resume-from-form/`;
        }
        const formData = new FormData();
        formData.append("download_format", format);
        if (selectedApi === "generate-resume-from-upload" && uploadedFiles && uploadedFiles.length > 0) {
          formData.append("file", uploadedFiles[0]);
        }
        try {
          const response = await fetch(endpoint, {
            method: "POST",
            body: formData,
          });
          if (!response.ok) throw new Error("Error downloading file.");
          const blob = await response.blob();
          triggerDownload(blob, `generated_resume.${format}`);
        } catch (e) {
          console.error(e);
        }
      }
      
      // Client-side conversion using jsPDF, html2canvas, and html-docx-js when needed
      async function triggerDownload(blob, filename) {
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
      
      // Initial render
      renderSidebar();
      renderMainCenter();
      renderResultsPanel();
    </script>
  </body>
</html>